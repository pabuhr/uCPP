% Remember to use the lgrind style

\File{\1u0\1usystem\1software\1u++\-7.0.0\1src\1examples\1IO\1ServerINETSTREAM.cc},{08:04},{Jan 20 2024}
\L{\LB{\C{}\1\1\0}}
\CE{}\L{\LB{\C{}\1\1\0uC++\0Version\07.0.0,\0Copyright\0(C)\0Peter\0A.\0Buhr\01994}}
\CE{}\L{\LB{\C{}\1\1\0}}
\CE{}\L{\LB{\C{}\1\1\0ServerINETSTREAM.cc\0\-\-\0Server\0for\0INET\1stream\0socket\0test.\0Server\0accepts\0multiple\0connections\0from\0clients.\0Each}}
\CE{}\L{\LB{\C{}\1\1\0\0\0\0\0client\0then\0communicates\0with\0an\0acceptor.\0\0The\0acceptor\0reads\0the\0data\0from\0the\0client\0and\0writes\0it\0back.}}
\CE{}\L{\LB{\C{}\1\1\0}}
\CE{}\L{\LB{\C{}\1\1\0Author\0\0\0\0\0\0\0\0\0\0\0:\0Peter\0A.\0Buhr}}
\CE{}\L{\LB{\C{}\1\1\0Created\0On\0\0\0\0\0\0\0:\0Tue\0Jan\0\07\008:40:22\01992}}
\CE{}\L{\LB{\C{}\1\1\0Last\0Modified\0By\0:\0Peter\0A.\0Buhr}}
\CE{}\L{\LB{\C{}\1\1\0Last\0Modified\0On\0:\0Sat\0Jan\020\008:04:13\02024}}
\CE{}\L{\LB{\C{}\1\1\0Update\0Count\0\0\0\0\0:\0194}}
\CE{}\L{\LB{\C{}\1\1}}
\CE{}\L{\LB{\C{}\1\1\0This\0\0library\0is\0free\0\0software;\0you\0\0can\0redistribute\0\0it\0and\1or\0\0modify\0it}}
\CE{}\L{\LB{\C{}\1\1\0under\0the\0terms\0of\0the\0GNU\0Lesser\0General\0Public\0License\0as\0published\0by\0the}}
\CE{}\L{\LB{\C{}\1\1\0Free\0Software\0\0Foundation;\0either\0\0version\02.1\0of\0\0the\0License,\0or\0\0(at\0your}}
\CE{}\L{\LB{\C{}\1\1\0option)\0any\0later\0version.}}
\CE{}\L{\LB{\C{}\1\1\0}}
\CE{}\L{\LB{\C{}\1\1\0This\0library\0is\0distributed\0in\0the\0\0hope\0that\0it\0will\0be\0useful,\0but\0WITHOUT}}
\CE{}\L{\LB{\C{}\1\1\0ANY\0\0WARRANTY;\0\0without\0even\0\0the\0\0implied\0\0warranty\0\0of\0MERCHANTABILITY\0\0or}}
\CE{}\L{\LB{\C{}\1\1\0FITNESS\0FOR\0A\0PARTICULAR\0PURPOSE.\0\0See\0the\0GNU\0Lesser\0General\0Public\0License}}
\CE{}\L{\LB{\C{}\1\1\0for\0more\0details.}}
\CE{}\L{\LB{\C{}\1\1\0}}
\CE{}\L{\LB{\C{}\1\1\0You\0should\0\0have\0received\0a\0\0copy\0of\0the\0\0GNU\0Lesser\0General\0\0Public\0License}}
\CE{}\L{\LB{\C{}\1\1\0along\0\0with\0this\0library.}}
\CE{}\L{\LB{\C{}\1\1\0}}
\CE{}\L{\LB{}}
\L{\LB{\K{\#include}\0\<\V{uSocket}.\V{h}\>}}
\L{\LB{\K{\#include}\0\<\V{iostream}\>}}
\L{\LB{\K{using}\0\V{std}::\V{cout};}}
\L{\LB{\K{using}\0\V{std}::\V{cerr};}}
\L{\LB{\K{using}\0\V{std}::\V{osacquire};}}
\L{\LB{\K{using}\0\V{std}::\V{endl};}}
\L{\LB{}}
\L{\LB{\K{enum}\0\{\0\V{BufferSize}\0=\08\0\*\01024\0\};}}
\L{\LB{\K{const}\0\K{char}\0\V{EOD}\0=\0\S{}\'\2377\'\SE{};}}
\L{\LB{\K{const}\0\K{char}\0\V{EOT}\0=\0\S{}\'\2376\'\SE{};}}
\L{\LB{}}
\L{\LB{\K{\_Task}\0\V{Server};}\Tab{56}{\C{}\1\1\0forward\0declaration}}
\CE{}\L{\LB{}}
\L{\LB{\K{\_Task}\0\V{Acceptor}\0\{}}
\L{\LB{}\Tab{4}{\V{uSocketServer}\0\&\V{sockserver};}}
\L{\LB{}\Tab{4}{\V{Server}\0\&\V{server};}}
\L{\LB{}}
\L{\LB{}\Tab{4}{\K{void}\0\V{main}();}}
\L{\LB{\0\0\K{public}:}}
\L{\LB{}\Tab{4}{\V{Acceptor}(\0\V{uSocketServer}\0\&\V{socks},\0\V{Server}\0\&\V{server}\0)\0:\0\V{sockserver}(\0\V{socks}\0),\0\V{server}(\0\V{server}\0)\0\{}}
\L{\LB{}\Tab{4}{\}\0\C{}\1\1\0Acceptor::Acceptor}}
\CE{}\L{\LB{\};\0\C{}\1\1\0Acceptor}}
\CE{}\L{\LB{}}
\L{\LB{\K{\_Task}\0\V{Server}\0\{}}
\L{\LB{}\Tab{4}{\V{uSocketServer}\0\&\V{sockserver};}}
\L{\LB{}\Tab{4}{\V{Acceptor}\0\*\V{terminate};}}
\L{\LB{}\Tab{4}{\K{int}\0\V{acceptorCnt};}}
\L{\LB{}\Tab{4}{\K{bool}\0\V{timeout};}}
\L{\LB{\0\0\K{public}:}}
\L{\LB{}\Tab{4}{\V{Server}(\0\V{uSocketServer}\0\&\V{socks}\0)\0:\0\V{sockserver}(\0\V{socks}\0),\0\V{acceptorCnt}(\01\0),\0\V{timeout}(\0\K{false}\0)\0\{}}
\L{\LB{}\Tab{4}{\}\0\C{}\1\1\0Server::Server}}
\CE{}\L{\LB{}}
\L{\LB{}\Tab{4}{\K{void}\0\V{connection}()\0\{}}
\L{\LB{}\Tab{4}{\}\0\C{}\1\1\0Server::connection}}
\CE{}\L{\LB{}}
\L{\LB{}\Tab{4}{\K{void}\0\V{complete}(\0\V{Acceptor}\0\*\V{terminate},\0\K{bool}\0\V{timeout}\0)\0\{}}
\L{\LB{}\Tab{8}{\V{Server}::\V{terminate}\0=\0\V{terminate};}}
\L{\LB{}\Tab{8}{\V{Server}::\V{timeout}\0=\0\V{timeout};}}
\L{\LB{}\Tab{4}{\}\0\C{}\1\1\0Server::complete}}
\CE{}\L{\LB{\0\0\K{private}:}}
\L{\LB{}\Tab{4}{\K{void}\0\V{main}()\0\{}}
\L{\LB{}\Tab{8}{\K{new}\0\V{Acceptor}(\0\V{sockserver},\0\*\K{this}\0);}\Tab{56}{\C{}\1\1\0create\0initial\0acceptor}}
\CE{}\L{\LB{}\Tab{8}{\K{for}\0(\0;;\0)\0\{}}
\L{\LB{}\Tab{12}{\K{\_Accept}(\0\V{connection}\0)\0\{}}
\L{\LB{}\Tab{16}{\K{new}\0\V{Acceptor}(\0\V{sockserver},\0\*\K{this}\0);}\Tab{56}{\C{}\1\1\0create\0new\0acceptor\0after\0a\0connection}}
\CE{}\L{\LB{}\Tab{16}{\V{acceptorCnt}\0+=\01;}}
\L{\LB{}\Tab{12}{\}\0\K{or}\0\K{\_Accept}(\0\V{complete}\0)\0\{}\Tab{56}{\C{}\1\1\0acceptor\0has\0completed\0with\0client}}
\CE{}\L{\LB{}\Tab{16}{\K{delete}\0\V{terminate};}\Tab{56}{\C{}\1\1\0delete\0must\0appear\0here\0or\0deadlock}}
\CE{}\L{\LB{}\Tab{16}{\V{acceptorCnt}\0\-=\01;}}
\L{\LB{}\Tab{8}{\0\0\K{if}\0(\0\V{acceptorCnt}\0==\00\0)\0\K{break};}\Tab{56}{\C{}\1\1\0if\0no\0outstanding\0connections,\0stop}}
\CE{}\L{\LB{}\Tab{16}{\K{if}\0(\0\V{timeout}\0)\0\{}}
\L{\LB{}\Tab{20}{\K{new}\0\V{Acceptor}(\0\V{sockserver},\0\*\K{this}\0);}\Tab{56}{\C{}\1\1\0create\0new\0acceptor\0after\0a\0timeout}}
\CE{}\L{\LB{}\Tab{20}{\V{acceptorCnt}\0+=\01;}}
\L{\LB{}\Tab{16}{\}\0\C{}\1\1\0if}}
\CE{}\L{\LB{}\Tab{12}{\}\0\C{}\1\1\0\_Accept}}
\CE{}\L{\LB{}\Tab{8}{\}\0\C{}\1\1\0for}}
\CE{}\L{\LB{}\Tab{4}{\}\0\C{}\1\1\0Server::main}}
\CE{}\L{\LB{\};\0\C{}\1\1\0Server}}
\CE{}\L{\LB{}}
\L{\LB{\K{void}\0\V{Acceptor}::\V{main}()\0\{}}
\L{\LB{}\Tab{4}{\K{try}\0\{}}
\L{\LB{}\Tab{8}{\V{uDuration}\0\V{timeout}(\020,\00\0);}\Tab{56}{\C{}\1\1\0timeout\0for\0accept}}
\CE{}\L{\LB{}\Tab{8}{\V{uSocketAccept}\0\V{acceptor}(\0\V{sockserver},\0\&\V{timeout}\0);}\Tab{56}{\C{}\1\1\0accept\0a\0connection\0from\0a\0client}}
\CE{}\L{\LB{}\Tab{8}{\K{char}\0\V{buf}[\V{BufferSize}];}}
\L{\LB{}\Tab{8}{\K{int}\0\V{len};}}
\L{\LB{}}
\L{\LB{}\Tab{8}{\V{server}.\V{connection}();}\Tab{56}{\C{}\1\1\0tell\0server\0about\0client\0connection}}
\CE{}\L{\LB{}\Tab{8}{\K{for}\0(\0;;\0)\0\{}}
\L{\LB{}\Tab{12}{\V{len}\0=\0\V{acceptor}.\V{read}(\0\V{buf},\0\K{sizeof}(\V{buf})\0);}\Tab{56}{\C{}\1\1\0read\0byte\0from\0client}}
\CE{}\L{\LB{}\Tab{12}{\C{}\1\1\0osacquire(\0cerr\0)\0\<\<\0\"Server::acceptor\0read\0len:\"\0\<\<\0len\0\<\<\0endl;}}
\CE{}\L{\LB{}\Tab{8}{\0\0\K{if}\0(\0\V{len}\0==\00\0)\0\V{abort}(\0\S{}\"server\0\%d\0:\0EOF\0ecountered\0without\0EOD\"\SE{},\0\V{getpid}()\0);}}
\L{\LB{}\Tab{12}{\V{acceptor}.\V{write}(\0\V{buf},\0\V{len}\0);}\Tab{56}{\C{}\1\1\0write\0byte\0back\0to\0client}}
\CE{}\L{\LB{}\Tab{12}{\C{}\1\1\0The\0EOD\0character\0can\0be\0piggy\-backed\0onto\0the\0end\0of\0the\0message.}}
\CE{}\L{\LB{}\Tab{8}{\0\0\K{if}\0(\0\V{buf}[\V{len}\0\-\01]\0==\0\V{EOD}\0)\0\K{break};}\Tab{56}{\C{}\1\1\0end\0of\0data\0?}}
\CE{}\L{\LB{}\Tab{8}{\}\0\C{}\1\1\0for}}
\CE{}\L{\LB{}\Tab{8}{\V{len}\0=\0\V{acceptor}.\V{read}(\0\V{buf},\0\K{sizeof}(\V{buf})\0);}\Tab{56}{\C{}\1\1\0read\0EOT\0from\0client}}
\CE{}\L{\LB{}\Tab{8}{\K{if}\0(\0\V{len}\0!=\01\0\&\&\0\V{buf}[0]\0!=\0\V{EOT}\0)\0\{}}
\L{\LB{}\Tab{12}{\V{abort}(\0\S{}\"server\0\%d\0:\0failed\0to\0read\0EOT\"\SE{},\0\V{getpid}()\0);}}
\L{\LB{}\Tab{8}{\}\0\C{}\1\1\0if}}
\CE{}\L{\LB{}\Tab{8}{\V{server}.\V{complete}(\0\K{this},\0\K{false}\0);}\Tab{56}{\C{}\1\1\0terminate}}
\CE{}\L{\LB{}\Tab{4}{\}\0\K{catch}(\0\V{uSocketAccept}::\V{OpenTimeout}\0\&\0)\0\{}}
\L{\LB{}\Tab{8}{\V{server}.\V{complete}(\0\K{this},\0\K{true}\0);}\Tab{56}{\C{}\1\1\0terminate}}
\CE{}\L{\LB{}\Tab{4}{\}\0\C{}\1\1\0try}}
\CE{}\L{\LB{\}\0\C{}\1\1\0Acceptor::main}}
\CE{}\L{\LB{}}
\L{\LB{\K{int}\0\V{main}(\0\K{int}\0\V{argc},\0\K{char}\0\*\V{argv}[\,]\0)\0\{}}
\L{\LB{}\Tab{4}{\K{switch}\0(\0\V{argc}\0)\0\{}}
\L{\LB{}\Tab{4}{\0\0\K{case}\01:}}
\L{\LB{}\Tab{8}{\K{break};}}
\L{\LB{}\Tab{4}{\0\0\K{default}:}}
\L{\LB{}\Tab{8}{\V{cerr}\0\<\<\0\S{}\"Usage:\0\"\SE{}\0\<\<\0\V{argv}[0]\0\<\<\0\V{endl};}}
\L{\LB{}\Tab{8}{\V{exit}(\0\V{EXIT\_FAILURE}\0);}}
\L{\LB{}\Tab{4}{\}\0\C{}\1\1\0switch}}
\CE{}\L{\LB{}}
\L{\LB{}\Tab{4}{\K{short}\0\K{unsigned}\0\K{int}\0\V{port};}}
\L{\LB{}\Tab{4}{\V{uSocketServer}\0\V{sockserver}(\0\&\V{port}\0);}\Tab{56}{\C{}\1\1\0create\0and\0bind\0a\0server\0socket\0to\0free\0port}}
\CE{}\L{\LB{}}
\L{\LB{}\Tab{4}{\V{cout}\0\<\<\0\V{port}\0\<\<\0\V{endl};}\Tab{56}{\C{}\1\1\0print\0out\0free\0port\0for\0clients}}
\CE{}\L{\LB{}\Tab{4}{\{}}
\L{\LB{}\Tab{8}{\V{Server}\0\V{s}(\0\V{sockserver}\0);}\Tab{56}{\C{}\1\1\0execute\0until\0acceptor\0times\0out}}
\CE{}\L{\LB{}\Tab{4}{\}}}
\L{\LB{\}\0\C{}\1\1\0uMain}}
\CE{}\L{\LB{}}
\L{\LB{\C{}\1\1\0Local\0Variables:\0\1\1}}
\CE{}\L{\LB{\C{}\1\1\0compile\-command:\0\"u++\-work\0ServerINETSTREAM.cc\0\-o\0Server\"\0\1\1}}
\CE{}\L{\LB{\C{}\1\1\0End:\0\1\1}}
\CE{}